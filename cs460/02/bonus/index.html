<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>A2 Bonus – Spheres + Camera Cycle</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body{margin:0;height:100%;background:#000;color:#fff;font:16px system-ui,Arial}
    header{ text-align:center; padding:14px 0 }
    #r{ width:100vw; height:74vh; display:block }
    .help{ max-width:960px; margin:6px auto 0; padding:0 12px; line-height:1.45 }
    kbd{ padding:2px 6px; border:1px solid #888; border-bottom-width:2px; border-radius:4px; background:#111 }
    .hud{ position:fixed; left:10px; bottom:10px; background:#111b; border:1px solid #333; border-radius:8px; padding:8px 10px; font-size:13px }
  </style>
</head>
<body>
  <header>
    <h1>A2 Bonus – Spheres + Camera Cycle</h1>
    <div class="help">
      Keys: <kbd>C</kbd> save camera, <kbd>V</kbd> play/stop camera tour,
      <kbd>O</kbd> download scene, <kbd>L</kbd> load <code>scene.json</code> (from this folder).
    </div>
  </header>

  <div id="r"></div>
  <div class="hud" id="hud">cams: 0 • tour: off</div>

  <script src="../xtk.js"></script>
  <script src="loader.js"></script>
  <script>
    // ===== Global state =====
    var r;
    var CAMERAS = [];        // saved camera views (Float32Array)
    var TOUR_ON = false;
    var tourTimer = null;
    var hud = document.getElementById('hud');

    // ===== Sphere layout params (non-overlapping) =====
    // We place centers on a fixed lattice (CELL apart),
    // and keep radii small enough that 2*radius < CELL.
    const CELL   = 26;       // distance between centers on the grid
    const RMIN   = 6;        // min radius
    const RMAX   = 10;       // max radius  (2*RMAX = 20 < CELL = 26 -> 6px gap)
    const COUNT  = 7;        // COUNT^3 spheres; 7^3 = 343 (nice + fast)

    function rand(a,b){ return a + Math.random()*(b-a); }

    function updateHUD(){
      hud.textContent = `cams: ${CAMERAS.length} • tour: ${TOUR_ON ? 'on' : 'off'}`;
    }

    window.onload = function () {
      // Renderer
      r = new X.renderer3D();
      r.container = 'r';
      r.init();

      // ------- Make a tidy lattice of spheres (no overlaps) -------
      const half = (COUNT-1)/2; // centers from -half..+half
      for (let z=-half; z<=half; z++){
        for (let y=-half; y<=half; y++){
          for (let x=-half; x<=half; x++){
            const s = new X.sphere();

            // set radius first, then position
            const radius = rand(RMIN, RMAX);
            s.radius = radius;

            // pretty color
            s.color = [ Math.random(), Math.random(), Math.random() ];

            // place sphere on grid
            s.transform.translateX(x * CELL);
            s.transform.translateY(y * CELL);
            s.transform.translateZ(z * CELL);

            r.add(s);
          }
        }
      }

      // Camera a bit back so the full block is visible
      r.camera.position = [0, 0, 420];

      // On every render tick: nothing needed here, tour runs on a timer
      r.onRender = function(){};

      // Controls: C, V, O, L
      window.onkeypress = function(e){
        const k = e.key.toLowerCase();

        if (k === 'c'){
          // Save current camera view
          CAMERAS.push(new Float32Array(r.camera.view));
          updateHUD();
          return;
        }

        if (k === 'v'){
          if (!TOUR_ON){
            if (CAMERAS.length < 2){
              alert('Save at least two camera views with C before starting the tour.');
              return;
            }
            TOUR_ON = true;
            let idx = 0;
            tourTimer = setInterval(function(){
              r.camera.view = CAMERAS[idx % CAMERAS.length];
              idx++;
            }, 1000); // 1 second per view
          } else {
            TOUR_ON = false;
            clearInterval(tourTimer);
          }
          updateHUD();
          return;
        }

        if (k === 'o' && typeof download === 'function'){
          // download current scene as scene.json
          download();
          return;
        }

        if (k === 'l' && typeof upload === 'function'){
          // IMPORTANT: load local file from THIS folder
          upload('scene.json');
          return;
        }
      };

      updateHUD();
      r.render();
    };
  </script>
</body>
</html>
