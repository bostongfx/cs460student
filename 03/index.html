<html>
    <head>
        <style>
        html, body { 
            background-color:#000;
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden !important;  
        }
        </style>
        
        <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>

        <script type="importmap">
        {
        "imports": {
            "three": "https://unpkg.com/three@latest/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@latest/examples/jsm/"
        }
        }
        </script>

        <script type="module">

            // Imports
            import * as THREE from 'three';
            import { OrbitControls } from 'three/addons/controls/OrbitControls.js';  
            
            // Global variables
                
            var renderer, controls, scene, camera, LASTTORUS, CLICKING, FLICKERING, WIREFRAME;
            var DELTA = 0.1;
            var lastY = 0;
            var toruses = [];

            window.onload = function() {

                // Inicializes the scene
                scene = new THREE.Scene();

                // Sets up the camera
                var fov = 75;
                var ratio = window.innerWidth / window.innerHeight;
                var zNear = 1;
                var zFar = 10000;
                camera = new THREE.PerspectiveCamera(fov, ratio, zNear, zFar);
                camera.position.set(0, 0, 100);

                // Creates renderer and setup the canvas
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                document.body.appendChild(renderer.domElement);


                // Creates a torus everytime the mouse is clicked
                renderer.domElement.onmousedown = function(e){            
                    if (e.shiftKey) {

                        // Stops the orbit controls
                        controls.enabled = false;

                        // Alows the modification of the torus
                        CLICKING = true;

                        // Gets the coordinates for where was clicked and normalizes them
                        var pixel_coords = new THREE.Vector2(e.clientX, e.clientY);

                        var vp_coords = new THREE.Vector2((pixel_coords.x / window.innerWidth) * 2 - 1, -(pixel_coords.y / window.innerHeight) * 2 + 1);

                        var vp_coords_near = new THREE.Vector3(vp_coords.x, vp_coords.y, 0);

                        // Creates a ray from the camera through the point that was clicked and finds where it intersects the invible plane
                        var raycaster = new THREE.Raycaster();
                        raycaster.setFromCamera(vp_coords_near, camera);
                        var intersects = raycaster.intersectObject(invisible_plane);

                        // Configures the new torus
                        var geometry = new THREE.TorusKnotGeometry();
                        var material = new THREE.MeshStandardMaterial({ color: 0xFF69B4, wireframe: false});

                        LASTTORUS = new THREE.Mesh(geometry, material);

                        scene.add(LASTTORUS);

                        LASTTORUS.position.set(intersects[0].point.x, intersects[0].point.y, intersects[0].point.z);

                        // Adds the current torus to the list of toruses
                        toruses.push(LASTTORUS);
                    };
                };

                // The modification for the current torus
                renderer.domElement.onmousemove = function(e){
                    if (CLICKING) {
                        // Adjusts the edit value based on if the mouse is moving up or down
                        if (e.clientY < lastY) {
                            DELTA = 0.1;
                        } else if (e.clientY > lastY) {
                            DELTA = -0.1;
                        };

                        // Edits the size of the torus
                        LASTTORUS.scale.set(LASTTORUS.scale.x + DELTA, LASTTORUS.scale.y + DELTA, LASTTORUS.scale.z + DELTA);
                        
                        // Changes the color once the size "flips over"
                        if (LASTTORUS.scale.x < 0) {
                            LASTTORUS.material.color.set(0x7CFC00);
                        } else if (LASTTORUS.scale.x > 0) {
                            LASTTORUS.material.color.set(0xFF69B4);
                        };

                        // Keeps track of the last value of y
                        lastY = e.clientY; 
                    };
                };

                // Updates the values that need changing once the mouse is released
                renderer.domElement.onmouseup = function(e){
                    // Reneables the orbit controls
                    controls.enabled = true;

                    // Disallows the modification of the last torus
                    CLICKING = false;
                };

                // Adds functions when certain keys are pressed
                window.onkeypress = function(e) {
                    // Begins or ends the flickering
                    if (e.key == 'f') {
                        FLICKERING = !FLICKERING;
                        if (!FLICKERING) {
                            end_flickering();
                        };
                    };

                    // Sets all toruses to wirframe or returns them to normal
                    if (e.key == 'w') {
                        WIREFRAME = !WIREFRAME;
                        if (WIREFRAME) {
                            start_wireframe();
                        } else {
                            stop_wireframe();
                        };
                    };
                };

                // Sets up lights
                var ambientLight = new THREE.AmbientLight();
                scene.add(ambientLight);

                var light = new THREE.DirectionalLight(0xffffff, 5.0);
                light.position.set(10, 100, 10);
                scene.add(light);

                // Configures the default torus
                var geometry = new THREE.TorusKnotGeometry();
                var material = new THREE.MeshStandardMaterial({ color: 0x098765, wireframe: false});

                var torus = new THREE.Mesh(geometry, material);

                scene.add(torus);
                toruses.push(torus);

                // Sets up the invisible plane
                var geometry = new THREE.PlaneGeometry(10000, 10000);
                var material = new THREE.MeshBasicMaterial({visible: false});

                var invisible_plane = new THREE.Mesh(geometry, material);

                scene.add(invisible_plane);


                // Returns all toruses to full opacity
                function end_flickering() {
                    for (let i = 0; i < toruses.length; i++) {
                        toruses[i].material.opacity = 1;
                        toruses[i].material.transparent = true; 
                        toruses[i].material.needsUpdate = true; 
                    };
                };

                // Makes all toruses have their wireframe
                function start_wireframe() {
                    for (let i = 0; i < toruses.length; i++) {
                        toruses[i].material.wireframe = true;
                    };
                };

                // Returns all toruses to normal
                function stop_wireframe() {
                    for (let i = 0; i < toruses.length; i++) {
                        toruses[i].material.wireframe = false;
                    };
                };


                // Sets up the camera interaction
                controls = new OrbitControls(camera, renderer.domElement);

                // Calls animation/rendering loop
                animate();
                
            };

            function animate() {

                requestAnimationFrame(animate);

                // Makes all toruses flicker
                if (FLICKERING) {
                    for (let i = 0; i < toruses.length; i++) {
                        toruses[i].material.opacity = Math.random();
                        toruses[i].material.transparent = true; 
                        toruses[i].material.needsUpdate = true; 
                    };
                };

                controls.update();
                renderer.render(scene, camera);
                
            };
        </script>
    </head>
    <body></body>
</html>
